"""
Models for Galp messages

Not in actual use yet
"""

from typing import Literal, Annotated, TypeVar
from enum import Enum
from dataclasses import field, dataclass
from pydantic import Field, PlainSerializer

from . import task_types as gtt
from .task_types import TaskName, TaskDef, CoreTaskDef, TaskReference

class Role(str, Enum):
    """
    Enum identifying the role of a peer in the system
    """
    POOL = 'pool'
    WORKER = 'worker'

M = TypeVar('M', bound='Message')

@dataclass
class Message:
    """
    Base class for messages
    """

@dataclass
class Doing(Message):
    """
    A message signaling that a task has been allocated or started

    Attributes:
        name: the task name
    """
    name: TaskName

    verb: Literal['doing'] = field(default='doing', repr=False)

@dataclass
class Done(Message):
    """
    A message signaling that a task has been succesful run

    Attributes:
        task_def: the task
        children: the child tasks, typically not yet run, generated by the task
            execution
    """
    task_def: TaskDef
    result: gtt.ResultReference

    verb: Literal['done'] = field(default='done', repr=False)

@dataclass
class Exit(Message):
    """
    A message asking a peer to leave the system
    """
    verb: Literal['exit'] = field(default='exit', repr=False)

@dataclass
class Exited(Message):
    """
    Signals that a peer (unexpectedly) exited. This is typically sent by an
    other peer that detected the kill event

    Attributes:
        peer: the local id (pid) of the exited peer
    """
    peer: str

    verb: Literal['exited'] = field(default='exited', repr=False)

@dataclass
class Failed(Message):
    """
    Signals that the execution of task has failed

    Attributes:
        task_def: the definition of the failed task
    """
    task_def: CoreTaskDef

    verb: Literal['failed'] = field(default='failed', repr=False)

@dataclass
class Found(Message):
    """
    A message notifying that a task was registered, but not yet executed

    Attributes:
        task_def: the task definition
    """
    task_def: TaskDef

    verb: Literal['found'] = field(default='found', repr=False)

@dataclass
class Get(Message):
    """
    A message asking for an already computed resource

    Attributes:
        name: the task name
    """
    name: TaskName

    verb: Literal['get'] = field(default='get', repr=False)

    @property
    def task_key(self) -> bytes:
        """
        Unique request identifier
        """
        return f'{self.verb}:{self.name.hex()}'.encode('ascii')

@dataclass
class Illegal(Message):
    """
    A message notifying that a previously sent message was malformed

    Attributes:
        reason: an error message
    """
    reason:str

    verb: Literal['illegal'] = field(default='illegal', repr=False)

@dataclass
class NotFound(Message):
    """
    A message indicating that no trace of a task was found

    Attributes:
        name: the task name
    """
    name: TaskName

    verb: Literal['not_found'] = field(default='not_found', repr=False)

@dataclass
class Put(Message):
    """
    A message sending a serialized task result

    Atrributes:
        name: the task name whose result is sent
        data: the serialized result data
        children: the subordinate task references that are linked from within the
            serialized data
    """
    name: TaskName
    data: bytes
    children: list[TaskReference]

    verb: Literal['put'] = field(default='put', repr=False)

@dataclass
class Ready(Message):
    """
    A message advertising a peer joining the system

    Attributes:
        local_id: a string identifying the worker in a local system, typically the pid
        mission: a bytestring identifying why the peer is joining
    """
    role: Annotated[Role, PlainSerializer(lambda x: x.value)]
    local_id: str
    mission: bytes

    verb: Literal['ready'] = field(default='ready', repr=False)

@dataclass
class Stat(Message):
    """
    A message asking if a task is defined or executed

    Attributes:
        name: the task name
    """
    name: TaskName

    verb: Literal['stat'] = field(default='stat', repr=False)

    @property
    def task_key(self) -> bytes:
        """
        Unique request identifier
        """
        return f'{self.verb}:{self.name.hex()}'.encode('ascii')

@dataclass
class Submit(Message):
    """
    A message asking for a task to be executed

    Attributes:
        task_def: the task to execute
    """
    task_def: CoreTaskDef

    verb: Literal['submit'] = field(default='submit', repr=False)

    @property
    def task_key(self) -> bytes:
        """
        Unique request identifier
        """
        return f'{self.verb}:{self.task_def.name.hex()}'.encode('ascii')

AnyMessage = Annotated[
        Doing | Done | Exit | Exited | Failed | Found | Get | Illegal | NotFound
        | Put | Ready | Stat | Submit,
        Field(discriminator='verb')
        ]
